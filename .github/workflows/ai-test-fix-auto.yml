name: AI Test & Auto-Fix (Auto Merge)

on:
  workflow_dispatch:

jobs:
  vitest-ai-auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      # 1ï¸âƒ£ Repo'yu Ã§ek
      - name: Checkout Repo
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Node.js kurulumu
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3ï¸âƒ£ BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
      - name: Install Dependencies
        run: npm ci

      # 4ï¸âƒ£ Vitest testlerini Ã§alÄ±ÅŸtÄ±r, JSON olarak kaydet
      - name: Run Vitest Tests
        id: run-tests
        run: |
          npx vitest run --reporter=json > vitest-results.json || true

      # 5ï¸âƒ£ Test sonuÃ§larÄ±nÄ± artifact olarak sakla
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        with:
          name: vitest-results
          path: vitest-results.json

      # 6ï¸âƒ£ AI ile analiz et ve fixleri main branchâ€™e uygula
      - name: AI Analyze & Auto-Fix
        uses: github/auto-gpt-action@v1
        with:
          prompt: |
            Sen bir Node.js / Vitest / Prisma projesi asistanÄ±sÄ±n.
            - vitest-results.json iÃ§indeki test hatalarÄ±nÄ± analiz et
            - Eksik dosya ve importlarÄ± oluÅŸtur
            - Jest kodlarÄ±nÄ± Vitestâ€™e uygun hÃ¢le getir
            - Prisma foreign key ve DB hatalarÄ±nÄ± dÃ¼zelt
            - KodlarÄ± minimum deÄŸiÅŸiklikle Ã§alÄ±ÅŸÄ±r hÃ¢le getir
            - HatalarÄ± dÃ¼zelttikten sonra main branchâ€™e commit ve push yap
          artifact_path: vitest-results.json
          auto_commit: true
          commit_message: "ğŸ¤– AI Auto-Fix: Test ve Prisma HatalarÄ± DÃ¼zeltilmiÅŸtir"
          push_branch: main