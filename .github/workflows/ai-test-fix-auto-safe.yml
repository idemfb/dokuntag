name: AI Test & Auto-Fix (Safe Auto Merge)

on:
  workflow_dispatch:

jobs:
  vitest-ai-auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write

    steps:
      # 1ï¸âƒ£ Repo'yu Ã§ek
      - name: Checkout Repo
        uses: actions/checkout@v3

      # 2ï¸âƒ£ Node.js kurulumu
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3ï¸âƒ£ BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kle
      - name: Install Dependencies
        run: npm ci

      # 4ï¸âƒ£ Vitest testlerini Ã§alÄ±ÅŸtÄ±r, JSON olarak kaydet
      - name: Run Vitest Tests
        id: run-tests
        run: |
          npx vitest run --reporter=json > vitest-results.json || true

      # 5ï¸âƒ£ Test sonuÃ§larÄ±nÄ± artifact olarak sakla
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        with:
          name: vitest-results
          path: vitest-results.json

      # 6ï¸âƒ£ AI ile testleri analiz et ve fix Ã¶nerilerini uygula
      - name: AI Analyze & Fix
        id: ai-fix
        uses: github/auto-gpt-action@v1
        with:
          prompt: |
            Sen Node.js / Vitest / Prisma projesi iÃ§in AI test asistanÄ±sÄ±n.
            - vitest-results.json iÃ§indeki hatalarÄ± analiz et
            - Eksik dosya ve importlarÄ± oluÅŸtur
            - Jest kodlarÄ±nÄ± Vitestâ€™e uygun hÃ¢le getir
            - Prisma foreign key ve DB hatalarÄ±nÄ± dÃ¼zelt
            - KodlarÄ± minimum deÄŸiÅŸiklikle Ã§alÄ±ÅŸÄ±r hÃ¢le getir
            - Testleri geÃ§meden commit ve push yapma
          artifact_path: vitest-results.json
          auto_commit: true
          commit_message: "ğŸ¤– AI Auto-Fix: Test ve Prisma HatalarÄ± DÃ¼zeltilmiÅŸtir"
          push_branch: main

      # 7ï¸âƒ£ AIâ€™nin fixlerinden sonra testleri tekrar Ã§alÄ±ÅŸtÄ±r
      - name: Run Tests After Fix
        id: post-fix-tests
        run: |
          npx vitest run --reporter=json > post-fix-results.json || true

      # 8ï¸âƒ£ Test geÃ§iÅŸini kontrol et
      - name: Verify Tests Passed
        run: |
          FAILS=$(jq '.stats.failed' post-fix-results.json)
          if [ "$FAILS" -gt 0 ]; then
            echo "âŒ BazÄ± testler hala baÅŸarÄ±sÄ±z. Commit main'e alÄ±nmayacak."
            exit 1
          fi
          echo "âœ… TÃ¼m testler geÃ§ti. AI fix main branch'e push edildi."