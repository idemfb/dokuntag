
[1m[46m RUN [49m[22m [36mv4.0.18 [39m[90m/workspaces/dokuntag[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/loyalty.test.ts
[22m[39m[dotenv@17.2.4] injecting env (18) from .env -- tip: ğŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [31mâ¯[39m tests/loyalty.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[32m 18[2mms[22m[39m
[31m     [31mÃ—[31m Loyalty akÄ±ÅŸÄ± test edilmeli[39m[32m 16[2mms[22m[39m
 [31mâ¯[39m tests/auth.integration.test.ts [2m([22m[2m0 test[22m[2m)[22m
 [31mâ¯[39m tests/uid.test.ts [2m([22m[2m0 test[22m[2m)[22m
[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39m{"timestamp":"2026-02-16T14:26:57.242Z","level":"INFO","event":"CLAIM_ATTEMPT","payload":{"userId":"user-1","rewardId":"reward-1"}}

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query BEGIN IMMEDIATE

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query INSERT INTO `main`.`RewardClaim` (`id`, `userId`, `rewardId`, `idempotencyKey`, `status`, `createdAt`) VALUES (?,?,?,?,?,?) RETURNING `id` AS `id`, `userId` AS `userId`, `rewardId` AS `rewardId`, `idempotencyKey` AS `idempotencyKey`, `status` AS `status`, `refundReason` AS `refundReason`, `refundedAt` AS `refundedAt`, `createdAt` AS `createdAt`, `refundedBy` AS `refundedBy`

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query ROLLBACK

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39m{"timestamp":"2026-02-16T14:26:57.282Z","level":"ERROR","event":"CLAIM_FATAL","payload":{"userId":"user-1","rewardId":"reward-1","message":"\nInvalid `tx.rewardClaim.create()` invocation in\n/workspaces/dokuntag/app/features/loyalty/loyaltyService.ts:121:40\n\n  118 let statusCode = 201\n  119 \n  120 try {\nâ†’ 121   claim = await tx.rewardClaim.create(\nForeign key constraint violated: `foreign key`"}}

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39m{"timestamp":"2026-02-16T14:26:57.283Z","level":"INFO","event":"CLAIM_ATTEMPT","payload":{"userId":"user-1","rewardId":"reward-1"}}

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query BEGIN IMMEDIATE

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query INSERT INTO `main`.`RewardClaim` (`id`, `userId`, `rewardId`, `idempotencyKey`, `status`, `createdAt`) VALUES (?,?,?,?,?,?) RETURNING `id` AS `id`, `userId` AS `userId`, `rewardId` AS `rewardId`, `idempotencyKey` AS `idempotencyKey`, `status` AS `status`, `refundReason` AS `refundReason`, `refundedAt` AS `refundedAt`, `createdAt` AS `createdAt`, `refundedBy` AS `refundedBy`

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39mprisma:query ROLLBACK

[90mstdout[2m | tests/loyalty.integration.test.ts[2m > [22m[2mLoyalty Integration[2m > [22m[2mshould claim reward idempotently
[22m[39m{"timestamp":"2026-02-16T14:26:57.296Z","level":"ERROR","event":"CLAIM_FATAL","payload":{"userId":"user-1","rewardId":"reward-1","message":"\nInvalid `tx.rewardClaim.create()` invocation in\n/workspaces/dokuntag/app/features/loyalty/loyaltyService.ts:121:40\n\n  118 let statusCode = 201\n  119 \n  120 try {\nâ†’ 121   claim = await tx.rewardClaim.create(\nForeign key constraint violated: `foreign key`"}}

 [32mâœ“[39m tests/loyalty.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 59[2mms[22m[39m
[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39m{"timestamp":"2026-02-16T14:26:57.521Z","level":"INFO","event":"CLAIM_ATTEMPT","payload":{"userId":"user-2","rewardId":"reward-2"}}

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query BEGIN IMMEDIATE

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query INSERT INTO `main`.`RewardClaim` (`id`, `userId`, `rewardId`, `idempotencyKey`, `status`, `createdAt`) VALUES (?,?,?,?,?,?) RETURNING `id` AS `id`, `userId` AS `userId`, `rewardId` AS `rewardId`, `idempotencyKey` AS `idempotencyKey`, `status` AS `status`, `refundReason` AS `refundReason`, `refundedAt` AS `refundedAt`, `createdAt` AS `createdAt`, `refundedBy` AS `refundedBy`

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query ROLLBACK

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39m{"timestamp":"2026-02-16T14:26:57.550Z","level":"ERROR","event":"CLAIM_FATAL","payload":{"userId":"user-2","rewardId":"reward-2","message":"\nInvalid `tx.rewardClaim.create()` invocation in\n/workspaces/dokuntag/app/features/loyalty/loyaltyService.ts:121:40\n\n  118 let statusCode = 201\n  119 \n  120 try {\nâ†’ 121   claim = await tx.rewardClaim.create(\nForeign key constraint violated: `foreign key`"}}

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39m{"timestamp":"2026-02-16T14:26:57.550Z","level":"INFO","event":"CLAIM_ATTEMPT","payload":{"userId":"user-2","rewardId":"reward-2"}}

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query BEGIN IMMEDIATE

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query SELECT `main`.`IdempotencyRecord`.`id`, `main`.`IdempotencyRecord`.`userId`, `main`.`IdempotencyRecord`.`idempotencyKey`, `main`.`IdempotencyRecord`.`createdAt` FROM `main`.`IdempotencyRecord` WHERE ((`main`.`IdempotencyRecord`.`userId` = ? AND `main`.`IdempotencyRecord`.`idempotencyKey` = ?) AND 1=1) LIMIT ? OFFSET ?

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query INSERT INTO `main`.`RewardClaim` (`id`, `userId`, `rewardId`, `idempotencyKey`, `status`, `createdAt`) VALUES (?,?,?,?,?,?) RETURNING `id` AS `id`, `userId` AS `userId`, `rewardId` AS `rewardId`, `idempotencyKey` AS `idempotencyKey`, `status` AS `status`, `refundReason` AS `refundReason`, `refundedAt` AS `refundedAt`, `createdAt` AS `createdAt`, `refundedBy` AS `refundedBy`

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39mprisma:query ROLLBACK

[90mstdout[2m | tests/idempotency.integration.test.ts[2m > [22m[2mIdempotency[2m > [22m[2mshould return same claim for same idempotencyKey
[22m[39m{"timestamp":"2026-02-16T14:26:57.574Z","level":"ERROR","event":"CLAIM_FATAL","payload":{"userId":"user-2","rewardId":"reward-2","message":"\nInvalid `tx.rewardClaim.create()` invocation in\n/workspaces/dokuntag/app/features/loyalty/loyaltyService.ts:121:40\n\n  118 let statusCode = 201\n  119 \n  120 try {\nâ†’ 121   claim = await tx.rewardClaim.create(\nForeign key constraint violated: `foreign key`"}}

 [32mâœ“[39m tests/idempotency.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 58[2mms[22m[39m
 [32mâœ“[39m tests/rateLimit.integration.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 36[2mms[22m[39m
[90mstderr[2m | tests/env.validation.test.ts[2m > [22m[2mEnv Validation[2m > [22m[2mshould throw if JWT_SECRET is too short
[22m[39mEnvironment variable validation failed: {
  _errors: [],
  JWT_SECRET: { _errors: [ [32m'Too small: expected string to have >=32 characters'[39m ] }
}

 [32mâœ“[39m tests/env.validation.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 7[2mms[22m[39m
 [32mâœ“[39m tests/self.validation.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 3[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Suites 2 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/auth.integration.test.ts[2m [ tests/auth.integration.test.ts ][22m
[31m[1mError[22m: Cannot find module '../src/utils/validators' imported from '/workspaces/dokuntag/tests/auth.integration.test.ts'[39m
[36m [2mâ¯[22m tests/auth.integration.test.ts:[2m2:1[22m[39m
    [90m  1| [39m[35mimport[39m { describe[33m,[39m it[33m,[39m expect } [35mfrom[39m [32m'vitest'[39m[33m;[39m
    [90m  2| [39m[35mimport[39m { isValidUUID } [35mfrom[39m [32m'../src/utils/validators'[39m
    [90m   | [39m[31m^[39m
    [90m  3| [39m
    [90m  4| [39m[34mdescribe[39m([32m'Auth Validation'[39m[33m,[39m () [33m=>[39m {

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/3]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/uid.test.ts[2m [ tests/uid.test.ts ][22m
[31m[1mError[22m: Cannot find module '../src/utils/hash' imported from '/workspaces/dokuntag/tests/uid.test.ts'[39m
[36m [2mâ¯[22m tests/uid.test.ts:[2m2:1[22m[39m
    [90m  1| [39m[35mimport[39m { describe[33m,[39m it[33m,[39m expect } [35mfrom[39m [32m'vitest'[39m[33m;[39m
    [90m  2| [39m[35mimport[39m { hashPassword[33m,[39m verifyPassword } [35mfrom[39m [32m'../src/utils/hash'[39m
    [90m   | [39m[31m^[39m
    [90m  3| [39m
    [90m  4| [39m[34mdescribe[39m([32m'Password Hashing'[39m[33m,[39m () [33m=>[39m {

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/3]â¯[22m[39m


[31mâ¯â¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 1 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/loyalty.test.ts[2m > [22mLoyalty / Idempotency Test[2m > [22mLoyalty akÄ±ÅŸÄ± test edilmeli
[31m[1mTypeError[22m: Invalid URL[39m
[90m [2mâ¯[22m new Request node_modules/node-fetch/src/request.js:[2m55:16[22m[39m
[90m [2mâ¯[22m node_modules/node-fetch/src/index.js:[2m51:19[22m[39m
[90m [2mâ¯[22m fetch node_modules/node-fetch/src/index.js:[2m49:9[22m[39m
[36m [2mâ¯[22m tests/loyalty.test.ts:[2m18:21[22m[39m
    [90m 16| [39m
    [90m 17| [39m    [90m// 1ï¸âƒ£ BaÅŸlangÄ±Ã§ puanlarÄ±nÄ± al[39m
    [90m 18| [39m    let res = await fetch(`${BASE_URL}/api/loyalty/points?userId=${TESâ€¦
    [90m   | [39m                    [31m^[39m
    [90m 19| [39m    [35mconst[39m initialPoints [33m=[39m [35mawait[39m res[33m.[39m[34mjson[39m()
    [90m 20| [39m    console[33m.[39m[34mlog[39m([32m"BaÅŸlangÄ±Ã§ puanlarÄ±:"[39m[33m,[39m initialPoints)

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/3]â¯[22m[39m


[2m Test Files [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m5 passed[39m[22m[90m (8)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (7)[39m
[2m   Start at [22m 14:26:56
[2m   Duration [22m 2.12s[2m (transform 134ms, setup 0ms, import 440ms, tests 182ms, environment 1ms)[22m

