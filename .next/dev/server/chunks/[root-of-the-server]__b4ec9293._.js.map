{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\ndeclare global {\n  // eslint-disable-next-line no-var\n  var prisma: PrismaClient | undefined;\n}\n\nexport const prisma =\n  global.prisma ||\n  new PrismaClient({\n    log: ['query'],\n  });\n\nif (process.env.NODE_ENV !== 'production') {\n  global.prisma = prisma;\n}\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SACX,OAAO,MAAM,IACb,IAAI,sMAAY,CAAC;IACf,KAAK;QAAC;KAAQ;AAChB;AAEF,wCAA2C;IACzC,OAAO,MAAM,GAAG;AAClB"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/app/features/loyalty/logger.ts"],"sourcesContent":["import crypto from 'crypto'\n\nfunction hash(value: string) {\n  return crypto\n    .createHash('sha256')\n    .update(value)\n    .digest('hex')\n    .substring(0, 12)\n}\n\nfunction baseLog(level: string, event: string, payload: any) {\n  const safePayload = { ...payload }\n\n  if (safePayload.idempotencyKey) {\n    safePayload.idempotencyKey = hash(safePayload.idempotencyKey)\n  }\n\n  console.log(\n    JSON.stringify({\n      timestamp: new Date().toISOString(),\n      level,\n      event,\n      payload: safePayload,\n    })\n  )\n}\n\nexport function logInfo(event: string, payload: any) {\n  baseLog('INFO', event, payload)\n}\n\nexport function logWarn(event: string, payload: any) {\n  baseLog('WARN', event, payload)\n}\n\nexport function logError(event: string, payload: any) {\n  baseLog('ERROR', event, payload)\n}"],"names":[],"mappings":";;;;;;;;AAAA;;AAEA,SAAS,KAAK,KAAa;IACzB,OAAO,gHAAM,CACV,UAAU,CAAC,UACX,MAAM,CAAC,OACP,MAAM,CAAC,OACP,SAAS,CAAC,GAAG;AAClB;AAEA,SAAS,QAAQ,KAAa,EAAE,KAAa,EAAE,OAAY;IACzD,MAAM,cAAc;QAAE,GAAG,OAAO;IAAC;IAEjC,IAAI,YAAY,cAAc,EAAE;QAC9B,YAAY,cAAc,GAAG,KAAK,YAAY,cAAc;IAC9D;IAEA,QAAQ,GAAG,CACT,KAAK,SAAS,CAAC;QACb,WAAW,IAAI,OAAO,WAAW;QACjC;QACA;QACA,SAAS;IACX;AAEJ;AAEO,SAAS,QAAQ,KAAa,EAAE,OAAY;IACjD,QAAQ,QAAQ,OAAO;AACzB;AAEO,SAAS,QAAQ,KAAa,EAAE,OAAY;IACjD,QAAQ,QAAQ,OAAO;AACzB;AAEO,SAAS,SAAS,KAAa,EAAE,OAAY;IAClD,QAAQ,SAAS,OAAO;AAC1B"}},
    {"offset": {"line": 110, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/app/features/loyalty/metrics.ts"],"sourcesContent":["type MetricsMap = Record<string, number>\n\nconst counters: MetricsMap = {\n  claim_attempt_total: 0,\n  claim_success_total: 0,\n  claim_duplicate_total: 0,\n  claim_replay_total: 0,\n  claim_conflict_total: 0,\n  claim_retry_total: 0,\n  claim_fatal_total: 0,\n}\n\nexport function increment(metricName: string) {\n  if (!counters[metricName]) {\n    counters[metricName] = 0\n  }\n  counters[metricName]++\n}\n\nexport function getMetrics() {\n  return { ...counters }\n}"],"names":[],"mappings":";;;;;;AAEA,MAAM,WAAuB;IAC3B,qBAAqB;IACrB,qBAAqB;IACrB,uBAAuB;IACvB,oBAAoB;IACpB,sBAAsB;IACtB,mBAAmB;IACnB,mBAAmB;AACrB;AAEO,SAAS,UAAU,UAAkB;IAC1C,IAAI,CAAC,QAAQ,CAAC,WAAW,EAAE;QACzB,QAAQ,CAAC,WAAW,GAAG;IACzB;IACA,QAAQ,CAAC,WAAW;AACtB;AAEO,SAAS;IACd,OAAO;QAAE,GAAG,QAAQ;IAAC;AACvB"}},
    {"offset": {"line": 140, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/app/features/loyalty/loyaltyService.ts"],"sourcesContent":["// --- Ek Fonksiyonlar: addPoints, getUserPoints, listActiveRewards ---\nexport async function addPoints(userId: string, points: number) {\n  if (points <= 0) {\n    throw new Error('Puan 0dan büyük olmalı')\n  }\n  const user = await prisma.user.findUnique({ where: { id: userId } })\n  if (!user) {\n    throw new Error('Kullanıcı bulunamadı')\n  }\n  const updated = await prisma.loyaltyPoint.upsert({\n    where: { userId },\n    update: { points: { increment: points } },\n    create: { userId, points },\n  })\n  return { userId, points: updated.points }\n}\n\nexport async function getUserPoints(userId: string) {\n  const points = await prisma.loyaltyPoint.findUnique({ where: { userId } })\n  return points ?? { userId, points: 0 }\n}\n\nexport async function listActiveRewards() {\n  return await prisma.reward.findMany({ where: { active: true } })\n}\nimport { prisma } from '../../../lib/prisma'\nimport { Prisma } from '@prisma/client'\nimport { logInfo, logWarn, logError } from './logger'\nimport { increment } from './metrics'\n\ntype ClaimResponse = {\n  success: boolean\n  data?: any\n  error?: string\n  code?: string\n}\n\nexport async function claimReward(\n  userId: string,\n  rewardId: string,\n  idempotencyKey: string\n): Promise<{ response: ClaimResponse; statusCode: number }> {\n  increment('claim_attempt_total')\n  logInfo('CLAIM_ATTEMPT', { userId, rewardId })\n\n  // -------- PRE-CHECK (FAST REPLAY) --------\n  const existing = await prisma.idempotencyRecord.findUnique({\n    where: {\n      userId_idempotencyKey: {\n        userId,\n        idempotencyKey,\n      },\n    },\n  })\n\n  if (existing) {\n    if (existing.rewardId !== rewardId) {\n      increment('claim_conflict_total')\n      logWarn('CLAIM_CONFLICT', { userId, rewardId })\n      return {\n        response: {\n          success: false,\n          error: 'Idempotency-Key başka bir işlem için kullanılmış',\n          code: 'IDEMPOTENCY_CONFLICT',\n        },\n        statusCode: 409,\n      }\n    }\n\n    increment('claim_replay_total')\n    logInfo('CLAIM_IDEMPOTENT_REPLAY', { userId, rewardId })\n\n    return {\n      response: JSON.parse(existing.responseJson),\n      statusCode: existing.statusCode,\n    }\n  }\n\n  // -------- MAIN EXECUTION --------\n  return withRetry(async () => {\n    try {\n      return await prisma.$transaction(async (tx) => {\n        const idemp = await tx.idempotencyRecord.findUnique({\n          where: {\n            userId_idempotencyKey: {\n              userId,\n              idempotencyKey,\n            },\n          },\n        })\n\n        if (idemp) {\n          if (idemp.rewardId !== rewardId) {\n            increment('claim_conflict_total')\n            logWarn('CLAIM_CONFLICT', { userId, rewardId })\n\n            return {\n              response: {\n                success: false,\n                error: 'Idempotency-Key başka bir işlem için kullanılmış',\n                code: 'IDEMPOTENCY_CONFLICT',\n              },\n              statusCode: 409,\n            }\n          }\n\n          increment('claim_replay_total')\n          logInfo('CLAIM_IDEMPOTENT_REPLAY', { userId, rewardId })\n\n          return {\n            response: JSON.parse(idemp.responseJson),\n            statusCode: idemp.statusCode,\n          }\n        }\n\n        let claim\n        let response: ClaimResponse\n        let statusCode = 201\n\n        try {\n          claim = await tx.rewardClaim.create({\n            data: {\n              userId,\n              rewardId,\n              idempotencyKey,\n            },\n          })\n        } catch (e: any) {\n          if (\n            e instanceof Prisma.PrismaClientKnownRequestError &&\n            e.code === 'P2002'\n          ) {\n            increment('claim_duplicate_total')\n            logWarn('CLAIM_DUPLICATE', { userId, rewardId })\n\n            const replay = await tx.idempotencyRecord.findUnique({\n              where: {\n                userId_idempotencyKey: {\n                  userId,\n                  idempotencyKey,\n                },\n              },\n            })\n\n            if (replay) {\n              increment('claim_replay_total')\n              logInfo('CLAIM_IDEMPOTENT_REPLAY', { userId, rewardId })\n\n              return {\n                response: JSON.parse(replay.responseJson),\n                statusCode: replay.statusCode,\n              }\n            }\n          }\n\n          throw e\n        }\n\n        increment('claim_success_total')\n        logInfo('CLAIM_SUCCESS', { userId, rewardId })\n\n        response = {\n          success: true,\n          data: claim,\n        }\n\n        await tx.idempotencyRecord.create({\n          data: {\n            userId,\n            rewardId,\n            idempotencyKey,\n            responseJson: JSON.stringify(response),\n            statusCode,\n          },\n        })\n\n        return { response, statusCode }\n      })\n    } catch (err: any) {\n      increment('claim_fatal_total')\n      logError('CLAIM_FATAL', {\n        userId,\n        rewardId,\n        message: err.message,\n      })\n\n      return {\n        response: {\n          success: false,\n          error: err.message || 'Bilinmeyen hata',\n          code: err.code || 'ERROR',\n        },\n        statusCode: 500,\n      }\n    }\n  })\n}\n\n// ---------------- RETRY WRAPPER ----------------\n\nexport async function withRetry<T>(\n  fn: () => Promise<T>,\n  maxRetries = 3\n): Promise<T> {\n  let attempt = 0\n  let delay = 100\n\n  while (true) {\n    try {\n      return await fn()\n    } catch (err: any) {\n      const msg = String(err?.message || '').toLowerCase()\n      const code = err?.code\n\n      if (\n        attempt < maxRetries &&\n        (code === 'SQLITE_BUSY' ||\n          msg.includes('database is locked') ||\n          msg.includes('deadlock') ||\n          msg.includes('serialization failure'))\n      ) {\n        increment('claim_retry_total')\n        logWarn('CLAIM_RETRY', {\n          attemptNumber: attempt + 1,\n          reason: code || msg,\n        })\n\n        await new Promise((r) => setTimeout(r, delay))\n        attempt++\n        delay *= 2\n        continue\n      }\n\n      throw err\n    }\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 398, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/lib/errors.ts"],"sourcesContent":["/**\n * Enterprise-grade error handling system\n * Yapılandırılmış hata yönetimi, telemetry ve recovery\n */\n\nexport interface ErrorContext {\n  userId?: string;\n  rewardId?: string;\n  claimId?: string;\n  requestId?: string;\n  field?: string;\n  metadata?: Record<string, any>;\n}\n\nexport class LoyaltyError extends Error {\n  public readonly code: string;\n  public readonly statusCode: number;\n  public readonly context: ErrorContext;\n  public readonly timestamp: Date;\n  public readonly isDeveloperFacing: boolean;\n\n  constructor(\n    code: string,\n    statusCode: number,\n    message: string,\n    context: ErrorContext = {},\n    isDeveloperFacing: boolean = false\n  ) {\n    super(message);\n    this.name = 'LoyaltyError';\n    this.code = code;\n    this.statusCode = statusCode;\n    this.context = context;\n    this.timestamp = new Date();\n    this.isDeveloperFacing = isDeveloperFacing;\n\n    Error.captureStackTrace(this, this.constructor);\n  }\n\n  toJSON() {\n    return {\n      code: this.code,\n      message: this.message,\n      statusCode: this.statusCode,\n      timestamp: this.timestamp,\n      ...(this.isDeveloperFacing && { context: this.context }),\n    };\n  }\n}\n\n/**\n * BUSINESS LOGIC ERRORS (User-facing)\n */\n\nexport class InsufficientPointsError extends LoyaltyError {\n  constructor(context?: ErrorContext) {\n    super(\n      'INSUFFICIENT_POINTS',\n      400,\n      'Yeterli puan bulunmamaktadır',\n      context\n    );\n    this.name = 'InsufficientPointsError';\n  }\n}\n\nexport class RewardNotFoundError extends LoyaltyError {\n  constructor(rewardId: string, context?: ErrorContext) {\n    super(\n      'REWARD_NOT_FOUND',\n      404,\n      `Ödül bulunamadı: ${rewardId}`,\n      { ...context, rewardId },\n      true\n    );\n    this.name = 'RewardNotFoundError';\n  }\n}\n\nexport class UserNotFoundError extends LoyaltyError {\n  constructor(userId: string, context?: ErrorContext) {\n    super(\n      'USER_NOT_FOUND',\n      404,\n      `Kullanıcı bulunamadı: ${userId}`,\n      { ...context, userId },\n      true\n    );\n    this.name = 'UserNotFoundError';\n  }\n}\n\nexport class RewardInactiveError extends LoyaltyError {\n  constructor(rewardId: string, context?: ErrorContext) {\n    super(\n      'REWARD_INACTIVE',\n      400,\n      'Bu ödül artık aktif değildir',\n      { ...context, rewardId }\n    );\n    this.name = 'RewardInactiveError';\n  }\n}\n\nexport class DuplicateClaimError extends LoyaltyError {\n  constructor(claimId?: string, context?: ErrorContext) {\n    super(\n      'DUPLICATE_CLAIM',\n      409,\n      'Bu ödül zaten talep edilmiştir',\n      { ...context, claimId }\n    );\n    this.name = 'DuplicateClaimError';\n  }\n}\n\nexport class InvalidIdempotencyKeyError extends LoyaltyError {\n  constructor(context?: ErrorContext) {\n    super(\n      'INVALID_IDEMPOTENCY_KEY',\n      400,\n      'İdempotency key gerekli ve UUID formatında olmalıdır',\n      context\n    );\n    this.name = 'InvalidIdempotencyKeyError';\n  }\n}\n\n/**\n * SYSTEM ERRORS (Developer-facing)\n */\n\nexport class DatabaseError extends LoyaltyError {\n  constructor(originalError: Error, context?: ErrorContext) {\n    super(\n      'DATABASE_ERROR',\n      500,\n      'Veritabanı hatasından dolayı işlem tamamlanamamıştır',\n      { ...context, metadata: { originalError: originalError.message } },\n      true\n    );\n    this.name = 'DatabaseError';\n  }\n}\n\nexport class TransactionError extends LoyaltyError {\n  constructor(originalError: Error, context?: ErrorContext) {\n    super(\n      'TRANSACTION_ERROR',\n      500,\n      'İşlem sırasında bir hata oluştu. Lütfen tekrar deneyiniz',\n      { ...context, metadata: { originalError: originalError.message } },\n      true\n    );\n    this.name = 'TransactionError';\n  }\n}\n\nexport class ValidationError extends LoyaltyError {\n  constructor(field: string, message: string, context?: ErrorContext) {\n    super(\n      'VALIDATION_ERROR',\n      400,\n      `${field}: ${message}`,\n      { ...context, field }\n    );\n    this.name = 'ValidationError';\n  }\n}\n\nexport class RateLimitError extends LoyaltyError {\n  constructor(retryAfter: number, context?: ErrorContext) {\n    super(\n      'RATE_LIMIT_EXCEEDED',\n      429,\n      `Çok fazla istek gönderdiniz. ${retryAfter} saniye sonra tekrar deneyin`,\n      { ...context, metadata: { retryAfter } }\n    );\n    this.name = 'RateLimitError';\n  }\n}\n\nexport class UnauthorizedError extends LoyaltyError {\n  constructor(context?: ErrorContext) {\n    super(\n      'UNAUTHORIZED',\n      401,\n      'Yetkilendirme başarısız oldu',\n      context\n    );\n    this.name = 'UnauthorizedError';\n  }\n}\n\nexport class ForbiddenError extends LoyaltyError {\n  constructor(resource: string, context?: ErrorContext) {\n    super(\n      'FORBIDDEN',\n      403,\n      `Bu kaynağa erişim izni yoktur: ${resource}`,\n      { ...context, metadata: { resource } }\n    );\n    this.name = 'ForbiddenError';\n  }\n}\n\n/**\n * Compatibility class for old code\n */\nexport class ConcurrencyConflictError extends Error {\n  constructor(message = \"Başka bir işlem aynı anda gerçekleşti\") {\n    super(message);\n    this.name = \"ConcurrencyConflictError\";\n  }\n}\n\nexport class SystemError extends Error {\n  constructor(message = \"Sistem hatası oluştu\") {\n    super(message);\n    this.name = \"SystemError\";\n  }\n}\n\n/**\n * Utils\n */\n\nexport function isLoyaltyError(error: unknown): error is LoyaltyError {\n  return error instanceof LoyaltyError;\n}\n\nexport function getErrorStatus(error: unknown): number {\n  if (isLoyaltyError(error)) {\n    return error.statusCode;\n  }\n  return 500;\n}\n\nexport function formatErrorResponse(error: unknown) {\n  if (isLoyaltyError(error)) {\n    return {\n      code: error.code,\n      message: error.message,\n      status: error.statusCode,\n    };\n  }\n\n  return {\n    code: 'INTERNAL_SERVER_ERROR',\n    message: 'Bir sistem hatası oluştu',\n    status: 500,\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 613, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/lib/logger.ts"],"sourcesContent":["\n\n\n/**\n * Edge ve Node 18+ uyumlu SHA-256 hex hash fonksiyonu\n * Web Crypto API kullanır, sync fallback yoktur.\n */\nexport async function hashIdempotencyKey(key: string): Promise<string> {\n  if (!key) return '';\n  const encoder = new TextEncoder();\n  const data = encoder.encode(key);\n  // globalThis.crypto hem Node 18+ hem Edge'de mevcut\n  const hashBuffer = await globalThis.crypto.subtle.digest('SHA-256', data);\n  // Buffer'dan hex string'e çevir\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  const hex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');\n  return hex.slice(0, 12);\n}\n\nasync function redact(obj: any): Promise<any> {\n  if (!obj || typeof obj !== 'object') return obj;\n  const out: any = Array.isArray(obj) ? [] : {};\n  for (const k in obj) {\n    if (k.toLowerCase().includes('jwt')) {\n      out[k] = '[REDACTED]';\n    } else if (k === 'idempotencyKey') {\n      out[k] = await hashIdempotencyKey(obj[k]);\n    } else if (typeof obj[k] === 'object') {\n      out[k] = await redact(obj[k]);\n    } else {\n      out[k] = obj[k];\n    }\n  }\n  return out;\n}\n\n\ntype LogContext = {\n  requestId?: string;\n  userId?: string;\n  ip?: string;\n  [key: string]: any;\n};\n\nexport async function log(level: string, event: string, payload: object, context?: LogContext) {\n  const entry = {\n    timestamp: new Date().toISOString(),\n    level,\n    event,\n    ...context,\n    payload: await redact(payload),\n  };\n  // eslint-disable-next-line no-console\n  console.log(JSON.stringify(entry));\n}\n\nexport function logInfo(event: string, payload: object, context?: LogContext) {\n  log('info', event, payload, context);\n}\nexport function logWarn(event: string, payload: object, context?: LogContext) {\n  log('warn', event, payload, context);\n}\nexport function logError(event: string, payload: object, context?: LogContext) {\n  log('error', event, payload, context);\n}\n"],"names":[],"mappings":"AAGA;;;CAGC;;;;;;;;;;;;AACM,eAAe,mBAAmB,GAAW;IAClD,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,UAAU,IAAI;IACpB,MAAM,OAAO,QAAQ,MAAM,CAAC;IAC5B,oDAAoD;IACpD,MAAM,aAAa,MAAM,WAAW,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,WAAW;IACpE,gCAAgC;IAChC,MAAM,YAAY,MAAM,IAAI,CAAC,IAAI,WAAW;IAC5C,MAAM,MAAM,UAAU,GAAG,CAAC,CAAA,IAAK,EAAE,QAAQ,CAAC,IAAI,QAAQ,CAAC,GAAG,MAAM,IAAI,CAAC;IACrE,OAAO,IAAI,KAAK,CAAC,GAAG;AACtB;AAEA,eAAe,OAAO,GAAQ;IAC5B,IAAI,CAAC,OAAO,OAAO,QAAQ,UAAU,OAAO;IAC5C,MAAM,MAAW,MAAM,OAAO,CAAC,OAAO,EAAE,GAAG,CAAC;IAC5C,IAAK,MAAM,KAAK,IAAK;QACnB,IAAI,EAAE,WAAW,GAAG,QAAQ,CAAC,QAAQ;YACnC,GAAG,CAAC,EAAE,GAAG;QACX,OAAO,IAAI,MAAM,kBAAkB;YACjC,GAAG,CAAC,EAAE,GAAG,MAAM,mBAAmB,GAAG,CAAC,EAAE;QAC1C,OAAO,IAAI,OAAO,GAAG,CAAC,EAAE,KAAK,UAAU;YACrC,GAAG,CAAC,EAAE,GAAG,MAAM,OAAO,GAAG,CAAC,EAAE;QAC9B,OAAO;YACL,GAAG,CAAC,EAAE,GAAG,GAAG,CAAC,EAAE;QACjB;IACF;IACA,OAAO;AACT;AAUO,eAAe,IAAI,KAAa,EAAE,KAAa,EAAE,OAAe,EAAE,OAAoB;IAC3F,MAAM,QAAQ;QACZ,WAAW,IAAI,OAAO,WAAW;QACjC;QACA;QACA,GAAG,OAAO;QACV,SAAS,MAAM,OAAO;IACxB;IACA,sCAAsC;IACtC,QAAQ,GAAG,CAAC,KAAK,SAAS,CAAC;AAC7B;AAEO,SAAS,QAAQ,KAAa,EAAE,OAAe,EAAE,OAAoB;IAC1E,IAAI,QAAQ,OAAO,SAAS;AAC9B;AACO,SAAS,QAAQ,KAAa,EAAE,OAAe,EAAE,OAAoB;IAC1E,IAAI,QAAQ,OAAO,SAAS;AAC9B;AACO,SAAS,SAAS,KAAa,EAAE,OAAe,EAAE,OAAoB;IAC3E,IAAI,SAAS,OAAO,SAAS;AAC/B"}},
    {"offset": {"line": 679, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/lib/errorHandler.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { formatErrorResponse, getErrorStatus, isLoyaltyError } from './errors';\nimport { logError } from './logger';\n\nexport function withErrorHandler(handler: (req: any) => Promise<Response | ReturnType<typeof NextResponse.json>>) {\n  return async function (req: any) {\n    try {\n      // Delegate to original handler\n      const result = await handler(req);\n      return result as any;\n    } catch (err: unknown) {\n      // Log full error with stack when available for debugging\n      if (err instanceof Error) {\n        logError('UNHANDLED_API_ERROR', { message: err.message, stack: err.stack });\n      } else {\n        logError('UNHANDLED_API_ERROR', { err });\n      }\n\n      const formatted = formatErrorResponse(err);\n      const status = getErrorStatus(err);\n\n      // Include context for LoyaltyError in dev mode for debugging\n      const isDev = process.env.NODE_ENV !== 'production';\n      const responseBody: any = { success: false, error: formatted.message, code: formatted.code };\n      \n      if (isDev && isLoyaltyError(err) && (err as any).context) {\n        responseBody.context = (err as any).context;\n      }\n\n      return NextResponse.json(responseBody, { status });\n    }\n  };\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEO,SAAS,iBAAiB,OAA+E;IAC9G,OAAO,eAAgB,GAAQ;QAC7B,IAAI;YACF,+BAA+B;YAC/B,MAAM,SAAS,MAAM,QAAQ;YAC7B,OAAO;QACT,EAAE,OAAO,KAAc;YACrB,yDAAyD;YACzD,IAAI,eAAe,OAAO;gBACxB,IAAA,2HAAQ,EAAC,uBAAuB;oBAAE,SAAS,IAAI,OAAO;oBAAE,OAAO,IAAI,KAAK;gBAAC;YAC3E,OAAO;gBACL,IAAA,2HAAQ,EAAC,uBAAuB;oBAAE;gBAAI;YACxC;YAEA,MAAM,YAAY,IAAA,sIAAmB,EAAC;YACtC,MAAM,SAAS,IAAA,iIAAc,EAAC;YAE9B,6DAA6D;YAC7D,MAAM,QAAQ,oDAAyB;YACvC,MAAM,eAAoB;gBAAE,SAAS;gBAAO,OAAO,UAAU,OAAO;gBAAE,MAAM,UAAU,IAAI;YAAC;YAE3F,IAAI,SAAS,IAAA,iIAAc,EAAC,QAAQ,AAAC,IAAY,OAAO,EAAE;gBACxD,aAAa,OAAO,GAAG,AAAC,IAAY,OAAO;YAC7C;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC,cAAc;gBAAE;YAAO;QAClD;IACF;AACF"}},
    {"offset": {"line": 729, "column": 0}, "map": {"version":3,"sources":["file:///workspaces/dokuntag/app/api/loyalty/rewards/route.ts"],"sourcesContent":["export const dynamic = \"force-dynamic\";\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { listActiveRewards } from '../../../features/loyalty/loyaltyService';\nimport { withErrorHandler } from '@/lib/errorHandler';\n\n/**\n * GET /api/loyalty/rewards\n * List all active rewards that users can claim\n */\nexport const GET = withErrorHandler(async (req: NextRequest) => {\n  const url = new URL(req.url);\n\n  const querySchema = z.object({\n    limit: z.preprocess((v) => (v === undefined ? undefined : Number(v)), z.number().int().positive().max(100).optional()),\n    page: z.preprocess((v) => (v === undefined ? undefined : Number(v)), z.number().int().positive().optional()),\n  });\n\n  const parsed = querySchema.parse(Object.fromEntries(url.searchParams.entries()));\n\n  // For now listActiveRewards ignores pagination but we validate inputs\n  const rewards = await listActiveRewards();\n  return NextResponse.json({ success: true, data: rewards, meta: parsed }, { status: 200 });\n});"],"names":[],"mappings":";;;;;;AAEA;AACA;AACA;AACA;AALO,MAAM,UAAU;;;;;AAWhB,MAAM,MAAM,IAAA,yIAAgB,EAAC,OAAO;IACzC,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG;IAE3B,MAAM,cAAc,oLAAC,CAAC,MAAM,CAAC;QAC3B,OAAO,oLAAC,CAAC,UAAU,CAAC,CAAC,IAAO,MAAM,YAAY,YAAY,OAAO,IAAK,oLAAC,CAAC,MAAM,GAAG,GAAG,GAAG,QAAQ,GAAG,GAAG,CAAC,KAAK,QAAQ;QACnH,MAAM,oLAAC,CAAC,UAAU,CAAC,CAAC,IAAO,MAAM,YAAY,YAAY,OAAO,IAAK,oLAAC,CAAC,MAAM,GAAG,GAAG,GAAG,QAAQ,GAAG,QAAQ;IAC3G;IAEA,MAAM,SAAS,YAAY,KAAK,CAAC,OAAO,WAAW,CAAC,IAAI,YAAY,CAAC,OAAO;IAE5E,sEAAsE;IACtE,MAAM,UAAU,MAAM,IAAA,mKAAiB;IACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE,SAAS;QAAM,MAAM;QAAS,MAAM;IAAO,GAAG;QAAE,QAAQ;IAAI;AACzF"}}]
}